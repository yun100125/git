<html>

<head>
<style>
	#info {
	  position: absolute;
	  top: 0px;
	  width: 100%;
	  padding: 10px;
	  text-align: center;
	  color: #ffff00
	}

	body {
	  overflow: hidden;
	}
</style>
</head>

<body> 
	<div style="position:absolute;top:20px;width:100%;background:pink;text-align:center">
	HW3<br>
	[turret]:A/D <br>
	[turn]:W/S <br>
	[tank]:up/down/left/right<br>
	[ball]:space=out/R=back
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js">
	</script>
	<script src="https://threejs.org/examples/js/controls/OrbitControls.js">
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
	<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js">
	</script>

<script>
	var renderer, camera, controls, scene, axes;
	var keyboard = new KeyboardState();
	var stats;
	var theta1 = -0.2;
	var theta2 = 0.2;
	var parts, base, turret, turn, cannon, tank;
	var ball, ballMesh;

	class Ball {
		constructor () {
		this.pos = new THREE.Vector3(10,0,0);
		this.vel = new THREE.Vector3();
		this.force = new THREE.Vector3(0,-10,0);
		
	  }
	  
	  update (dt) {
			this.vel.add (this.force.clone().multiplyScalar(dt));
		this.pos.add (this.vel.clone().multiplyScalar(dt));  
			if (this.pos.y-turn.position.y < 0) {
			this.stopped = true;
		}
		}
	  
	  setPos() {
		this.pos.x = 10
		this.pos.y = 0;
		this.pos.z = 0;
		
	  }
	  
	  getPos() {
		return this.pos;
	  }
	  
	  get isStopped () {
		return this.stopped === true ? 1: 0;
	  }

	 rebirth() {
		this.stopped = false;
		this.vel.set (5, 8, 0).setLength(20); 
	  }
	}



	init();
	animate();

	function buildParts() { 
	  parts = [];
		
		var mat = new THREE.MeshNormalMaterial()
		base = new THREE.Object3D();
		var baseMesh = new THREE.Mesh (new THREE.BoxGeometry (40,10,20), mat);
		base.add (baseMesh);
		baseMesh.position.set (-10,5,0);
		parts.push (base);
	 
		turret = new THREE.Mesh (new THREE.CylinderGeometry (10,10,10, 30),mat);
		parts.push (turret);
		
		turn = new THREE.Object3D();
		var turnMesh = new THREE.Mesh (new THREE.CylinderGeometry (1.5, 1.5, 10, 30), mat);
		turn.add (turnMesh);
		turnMesh.rotation.x = Math.PI/2;
		parts.push (turn);
		
		cannon = new THREE.Object3D()
		var cannon0 = new THREE.Object3D()
		var cannonMesh = new THREE.Mesh (new THREE.CylinderGeometry (1.5, 1.5, 10, 30), mat);
		cannon0.add (cannonMesh);
		cannonMesh.position.y = 5;
		cannon.add (cannon0);
		cannon0.rotation.z = -Math.PI/2;
		parts.push (cannon);
		
		ball = new Ball();
		var geometry = new THREE.SphereGeometry(1, 0, 0);
		ballMesh = new THREE.Mesh(geometry, new THREE.MeshNormalMaterial());
		parts.push (ballMesh);
	   
		return parts;
	}

	function buildTank(){

	  let parts = buildParts();
	  
	  let tank = new THREE.Object3D();

	  let base = parts[0]
	  tank.add (base);
	  
	  let turret = parts[1]
	  tank.add (turret)
	  turret.position.set (0, 15, 0);
	  console.log (theta1);
	  turret.rotation.y = theta1;
	  
	  let turn = parts[2]
	  turn.position.x = 10
	  turn.rotation.z = theta2;
	  turret.add (turn);
	  
	  let cannon = parts[3]
	  turn.add (cannon);
	  
		let ball = parts[4]
	  turn.add (ball);
	  
	  return tank;
	}

	function init() {

	  renderer = new THREE.WebGLRenderer({
		antialias: true
	  });
	  renderer.setSize(window.innerWidth, window.innerHeight);
	  renderer.setClearColor(0x888888);

	  document.body.appendChild(renderer.domElement);


	  camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 1000);
	  camera.position.z = 200;  // important

	  controls = new THREE.OrbitControls(camera, renderer.domElement);
	  
	  scene = new THREE.Scene();
	  
	  let gridXZ = new THREE.GridHelper(100, 20, 'red', 'white');
	  scene.add(gridXZ);
	  
		
		//scene.add (ballMesh);

	  let tank = buildTank();
	  
	  scene.add (tank);
		
	  
	}

	function animate() {
	  keyboard.update();
	  controls.update();

	  if(keyboard.pressed('A')){
		ball.setPos();
		if(theta1 <= 0.8) theta1 += 0.01;
	  }
	  else if(keyboard.pressed('D')){
		ball.setPos();
		if(theta1 >= -0.8) theta1 -= 0.01;
	  }
	  else if(keyboard.pressed('W')){
		ball.setPos();
		if(theta2 <= 0.6) theta2 += 0.01;
	  }
	  else if(keyboard.pressed('S')){
		ball.setPos();
		if(theta2 >= -0.4) theta2 -= 0.01;
	  }
	  if(keyboard.pressed('down')){
		ball.setPos();
		base.position.x -= 2;
		turret.position.x -= 2;
	  }
	  if(keyboard.pressed('up')){
		ball.setPos();
		base.position.x += 2;
		turret.position.x += 2;
	  }
	  if(keyboard.pressed('left')){
		ball.setPos();
		base.position.z -= 2;
		turret.position.z -= 2;
	  }
	  if(keyboard.pressed('right')){
		ball.setPos();
		base.position.z += 2;
		turret.position.z += 2;
	  }
	  turret.rotation.y = theta1;
		turn.rotation.z = theta2;

		ballMesh.position.copy (ball.getPos());
		if (ball.isStopped) {  // all balls stopped
		keyboard.update(); 
		if (keyboard.pressed('space')){
			ball.rebirth();
		}else if (keyboard.pressed('R')) {
		  ball.setPos();
		} 
	  } else {
			ball.update (0.1);
	  } 
	  
	  requestAnimationFrame (animate);
		render();
	}

	function render() {
	  renderer.render(scene, camera);
	  
	}

	// important to add this 
	// in jsfiddle!
	window.focus();



</script>
</body>

</html>
